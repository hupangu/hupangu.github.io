---
title: 'Mac 系统下 AOSP 下载/编译/阅读'
date: 2023-12-08
excerpt: '目前网上关于AOSP的下载编译阅读流程的纷繁复杂，其中很多都已经不在是最新方法，故作者重新整理了一份 AOSP 从下载到编译到阅读全流程以飨读者。'
permalink: /posts/2023/12/08/AOSP/
tags:
  - Android
  - AOSP
  - 整理分享
---

## 简介
> 目前网上关于AOSP的下载编译阅读流程的纷繁复杂，其中很多都已经不在是最新方法，故作者重新整理了一份 AOSP 从下载到编译到阅读全流程以飨读者。
> 
> 版本：1.0.0
> 
> 设备信息：Chip:M1 OS:14.1.2
> 
> **注意**
> - **本文只针对初次下载AOSP编译的开发者。**
> - **针对 Linux 系统 Google 推出了 [平台版AndroidStudio](https://developer.android.com/studio/platform?hl=zh-cn) 请自行查看。**


## 参考文档
> - [搭建编译环境](https://source.android.com/source/initializing?hl=zh-cn#setting-up-a-mac-os-x-build-environment)
> - [清华 Git repo 镜像](https://mirrors.tuna.tsinghua.edu.cn/help/git-repo/)
> - [清华 AOSP 镜像](https://mirrors.tuna.tsinghua.edu.cn/help/AOSP/)
> - [google AOSP docs zh-cn](https://source.android.google.cn/docs/setup/build?hl=zh-cn)
> - [Idegen README](https://android.googlesource.com/platform/development/+/master/tools/idegen/README)
> - [使用 AIDEGen 将 AOSP 项目导入 Android Studio](https://juejin.cn/post/7166061140298956836)

## 编译环境准备

在默认安装过程中，Mac OS 会在一个保留大小写但不区分大小写的文件系统中运行。Git 并不支持此类文件系统，而且此类文件系统会导致某些 Git 命令（例如 git status）的行为出现异常。因此，我们建议您始终在区分大小写的文件系统中对 AOSP 源文件进行操作。使用下文中介绍的磁盘映像可以非常轻松地做到这一点。
**Android AOSP下载编译后接近200G，所以在创建新分区时分配分配 >200g 存储卷**

通过 shell 使用以下命令创建磁盘映像：
```bash
hdiutil create -type SPARSE -fs 'Case-sensitive Journaled HFS+' -size 1024g ~/android.dmg
```
这将创建一个 .dmg.sparseimage 文件，该文件在装载后可用作具有 Android 开发所需格式的存储卷。

如果您以后需要更大的存储卷，还可以使用以下命令来调整稀疏映像的大小：
```bash
hdiutil resize -size <new-size-you-want>g ~/android.dmg.sparseimage
```
对于存储在主目录下的名为 android.dmg 的磁盘映像，您可以向 `~/.bash_profile` 中添加辅助函数：

要在执行 mountAndroid 时装载磁盘映像，请运行以下命令：
```bash
function mountAndroid { hdiutil attach ~/android.dmg.sparseimage -mountpoint /Volumes/android; }
```
要在执行 umountAndroid 时卸载磁盘映像，请运行以下命令：
```bash
function umountAndroid() { hdiutil detach /Volumes/android; }
```
## 下载 AOSP
### 下载 repo 工具
``` bash
mkdir ~/bin
PATH=~/bin:$PATH
curl https://mirrors.tuna.tsinghua.edu.cn/git/git-repo -o repo
chmod +x repo
```
或者使用tuna的git-repo镜像

### 初始化
使用清华镜像时有两种初始化方法：
1. 下载初始化包，解压初始化包获得初始repo然后再`sync`好处是避免因网络波动造成同步失败
2. 直接通过`init`进行下载

我因为网络状况较好，使用的第2种方法。

#### 方法1. 使用初始化包进行初始化
使用每月更新的初始化包进行初始化，由于首次同步需要下载约 60GB 数据，过程中任何网络故障都可能造成同步失败，我们强烈建议您使用[清华镜像AOSP初始化包](https://mirrors.tuna.tsinghua.edu.cn/aosp-monthly/aosp-latest.tar)进行初始化。

```bash
# 1.如果已下载[清华镜像AOSP初始化包]，此步可忽略
curl -OC - https://mirrors.tuna.tsinghua.edu.cn/aosp-monthly/aosp-latest.tar
# 2.解压 
tar xf aosp-latest.tar
# 3.解压得到的 AOSP 工程目录
#   这时 ls 的话什么也看不到，因为只有一个隐藏的 .repo 目录
cd AOSP   
# 4.同步，正常同步一遍即可得到完整目录
repo sync -c -j16
```

此后，每次只需运行 repo sync 即可保持同步。 我们强烈建议您保持每天同步，并尽量选择凌晨等低峰时间.

#### 方法2. 传统初始化方法
```bash
#1. 建立工作目录:
mkdir WORKING_DIRECTORY
cd WORKING_DIRECTORY

#2. 初始化仓库:
# 如果提示无法连接到 gerrit.googlesource.com，请参照git-repo的帮助页面的更新一节。
repo init -u https://mirrors.tuna.tsinghua.edu.cn/git/AOSP/platform/manifest

#3. 如果需要某个特定的 Android 版本(列表)：
repo init -u https://mirrors.tuna.tsinghua.edu.cn/git/AOSP/platform/manifest -b android-4.0.1_r1

#4. 同步源码树（以后只需执行这条命令来同步）：
repo sync -c j64
```
## 编译 AOSP
### 使用脚本初始化环境
> envsetup.sh 脚本会导入若干命令，让您能够使用 Android 源代码，其中包括本练习中使用的命令。
>
> 如需查看可用命令的完整列表，请运行以下命令：`hmm`

```bash
source build/envsetup.sh
```

### 选择要构建的目标
使用 lunch 选择要构建的目标。`lunch product_name-build_variant` 会选择 product_name 作为需要构建的产品，并选择 build_variant 作为需要构建的变体，然后将这些选择存储在环境中，以便供后续对 m 和其他类似命令的调用读取。

确切的配置可作为参数进行传递。例如，以下命令表示针对模拟器进行完整构建，并且启用所有调试功能。


`lunch aosp_arm-eng`
如果在没有参数的情况下运行，则 lunch 会提示您从菜单中选择目标，但请注意，菜单中并未包含所有可能的选项。如需了解 AOSP 支持的所有设备的 build 配置，请参阅选择设备 build，或询问您的团队成员您所使用的设备的正确 lunch 是什么。

所有构建目标都采用 BUILD-BUILDTYPE 形式，其中 BUILD 是表示特定功能组合的代号。BUILDTYPE 是以下类型之一：

|构建类型|使用情况|
|:-|:-|
|user	|权限受限；适用于生产环境|
|userdebug|	与“user”类似，但具有 root 权限和调试功能；是进行调试时的首选编译类型|
|eng	|具有额外调试工具的开发配置|
userdebug build |的运行方式应该与 user build 一样，且能够启用通常不符合平台安全模型的额外调试功能。这就使得 userdebug build 具有更强大的诊断功能，因此是进行 user 测试的最佳选择。使用 userdebug build 进行开发时，请遵循 userdebug 指南。

eng build 会优先考虑在平台上工作的工程师的工程生产率。eng 构建系统会关闭用于提供良好用户体验的各种优化。除此之外，eng build 的运行方式类似于 user 和 userdebug build，以便设备开发者能够看到代码在这些环境下的运行方式。

如需查看当前的启动设置，请运行以下命令：

```bash
echo "$TARGET_PRODUCT-$TARGET_BUILD_VARIANT"
```
### 编译
#### lunch
[TODO]
#### make
[TODO]
## 使用AIDEGen将源码导入AndroidStudio
**不要使用的`idegen`生成`.iml`和`.ipr`，请使用的`AIDEGen`**

### 基本用法
```bash
source build/envsetup.sh && lunch <TARGET>
aidegen Settings -i s
```
这里 `i` 是 IDE 的意思，`s` 代表 Android Studio。
没了，就这么简单。AIDEGen 会自动帮你把对应的模块编译一遍，顺带把梳理出的依赖用 Python 生成一个个的 dependency，最后直接帮你把 AS 拉起，项目自动打开。

### 高级用法
刚接触框架开发的同学，都遇到过不知道模块叫什么名字的困扰。AIDEGen 允许你直接跟模块路径，意味着你并不一定需要知道模块的具体名字，比如：
shell复制代码
```bash
$ aidegen frameworks/base/packages/BackupEncryption -i s
```
而如果你在负责框架里面的某个 native 模块，需要用 CLion，则可以：
arduino复制代码aidegen <module> -i c

这里 i 是 IDE 的意思，c 代表 CLion，也是非常好记。
前面说过，AIDEGen 会在每次导入前先把模块编译一遍，但很多时候我们把源码同步下来之后，第一件事就是已经整编过了，那这个时候理论上依赖关系已经明确了，有没有办法跳过编译流程呢？很简单，只需要：
```bash
aidegen <module> -i <ide> -s
```

这里 `s` 是 Skip 的意思，如此一来就可以直接跳过编译，利用现有依赖进行导入。

### 常见编译错误：
> Unsupported macOS SDK version "14.1" 

在`build/soong/cc/config/darwin_host.go`文件中添加`14`

```go
	darwinSupportedSdkVersions = []string{
		"11",
		"12",
		"13",
		"14",
	}
```

